import numpy as np
from flask import Flask, request, jsonify
from flask_cors import CORS
from per_names import per_names
import pickle
from predict import predict
from extract_manifest import extract_manifest
import json

app = Flask(__name__)
CORS(app)

# Permission Models
model_nn = pickle.load(open('models/NN-5L.pickle','rb'))
model_bagging = pickle.load(open('models/Bagging(DT).pickle', 'rb'))
model_lr = pickle.load(open('models/LogisticRegression.pickle', 'rb'))

# Intent Models
model_nn_intent = pickle.load(open('models/intent/NN-5L_intent.pkl', 'rb'))
model_bagging_intent = pickle.load(open('models/intent/Bagging(DT)_intent.pkl', 'rb'))
model_lr_intent = pickle.load(open('models/intent/LogisticRegression_intent.pkl', 'rb'))


models = (model_nn, model_bagging, model_lr)
models_intent = (model_nn_intent, model_bagging_intent, model_lr_intent)


@app.route('/', methods=['POST'])
def upload_and_predict():
    uploaded_file = request.files['file']
    if uploaded_file.filename == '':
        return "ERROR: File not provided"

    permissions_list, intent_list = extract_manifest(uploaded_file)

    output_permission = predict(permissions_list, models)
    output_intent = predict(intent_list, models_intent)

    output = json.dumps({
        "permission": output_permission,
        "intent": output_intent
    })
    return output

    

if __name__ == '__main__':
    app.run(port=5000, debug=False)